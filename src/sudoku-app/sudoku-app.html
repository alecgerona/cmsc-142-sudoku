<link rel="import" href="../../bower_components/polymer/polymer.html">
<link href="https://fonts.googleapis.com/css?family=Open+Sans" rel="stylesheet">
<link rel="import" href="sudoku-table.html">
<link rel="import" href="../../bower_components/paper-button/paper-button.html">
<link rel="import" href="../../bower_components/paper-spinner/paper-spinner.html">
<link rel="import" href="../../bower_components/paper-toast/paper-toast.html">
<link rel="import" href="../../bower_components/polymerfire/polymerfire.html">

<dom-module id="sudoku-app">
  <template>
    <firebase-app 
      auth-domain="cmsc-142-sudoku.firebaseapp.com"
      database-url="https://cmsc-142-sudoku.firebaseio.com"
      api-key="AIzaSyCrF6vpEbHdwptFB-NWvGHh83v6oTKqdyI"
    >
    </firebase-app>
    <firebase-document
      id="document"
      path="/sudoku/count"
      data="{{count}}"
    >
      
    </firebase-document>
    
    <style is="custom-style">
      :host {
        display: block;
        font-family: 'Open Sans', sans-serif;
      }
      
      .title {
        font-size: 500%;
        margin-bottom: 0;
        margin-top: 0;
      }
      
      .subtitle {
        margin-bottom: 10px;
      }
      
      .count {
        margin-top: 0;
        margin-bottom: 0;
      }
      
      .container {
        margin: auto;
        width: 800px;
        text-align: center;
      }
      
      #errorToast {
        --paper-toast-background-color: maroon;
        --paper-toast-color: white;
      }
      #successToast {
        --paper-toast-background-color: green;
        --paper-toast-color: white;
      }
      
      select {
         border: 0;
         font-size: 20px;
         font-weight: bold;
         padding: 2px 10px;
         width: 100px;
         *width: 100px;
         *background: #58B14C;
      }
      /*.button {*/
      /*  background-color: maroon;*/
      /*  color: white;*/
      /*  font-family: 'Open Sans', sans-serif;*/
      /*}*/
      
      paper-button {
        background: maroon;
        color: white;
      }
      
      --paper-button-disabled {
        background: black;
      }
      
      .button-set {
        margin: auto;
        width: 100%;7
      }
    </style>
    <h1 class="title" align="center">sudoku</h1>
    <h1 class="subtitle" align="center">Fresh and random Sudoku puzzles made every click.</h6>
    <h3 class="count" align="center"># {{count}}</h3>
    <br>
    <div class="container">
      <sudoku-table id="sudokuElement" board="[[board]]" loading="{{loading}}" count="{{count}}">
      
      </sudoku-table>
      <br>
      <select hidden$="{{loading}}" on-change="setDim" value$="{{dimension}}" id="dimension" disabled$={{loading}}>
        <option value="4" >4 x 4</option> 
        <option value="9" selected>9 x 9</option>
      </select>
      <select hidden$="{{loading}}" on-change="setDiff" value$="{{difficulty}}" id="difficulty" disabled$={{loading}}>
        <option value="20" selected>Easy</option> 
        <option value="40">Medium</option>
        <option value="60">Hard</option>
      </select>
      <label><input type="checkbox" id="chkX" on-tap="toggleX">Check X</label>
      <label><input type="checkbox" id="chkY" on-tap="toggleY">Check Y</label>
      <paper-button hidden$="{{loading}}" on-tap="randomize" id="random" class="button" disabled$={{loading}} raised>Random</paper-button>
      <paper-button hidden$="{{loading}}" on-tap="check" id="check" class ="button" raised>Check</paper-button>
      <paper-button hidden$="{{loading}}" on-tap="solve" id="solve" class="button" disabled$={{loading}} raised>Solve</paper-button>
    </div>
    <paper-toast id="errorToast">Oops, the puzzle isn't finished.</paper-toast>
    <paper-toast id="successToast">Congratulations!</paper-toast>
  </template>
  <script type="text/javascript" src="../js/main.js"></script>
  <script>
    Polymer({

      is: 'sudoku-app',

      properties: {
        prop1: {
          type: String,
          value: 'sudoku-app',
        },
        
        board: {
          type: Array,
          notify: true,
        },
        
        loading: {
          type: Boolean,
          value: true,
        },
        
        total: {
          type: Number,
          value: 0,
        },
        
        count: {
          type: Number,
          value: null,
          notify: true,
        },
        
        solutions: {
          type: Array,
          value: [],
          notify: true,
        },

        chkX: {
          type: Boolean,
          value: false,
        },

        chkY: {
          type: Boolean,
          value: false,
        },

        dimension: {
          type: Number,
          value: 9,
        },

        difficulty: {
          type: Number,
          value: 20,
        }
        
      },
      
      ready: function() {
        // console.log("READY");
      },
      
      randomize: function() {
        this.loading = !this.loading;
        this.$.sudokuElement.updating = !this.$.sudokuElement.updating;
        // this.$.sudokuElement.loading = !this.$.sudokuElement.loading;
        let w = new Worker("/src/js/worker.js");
        w.postMessage([this.dimension, this.chkX, this.chkY, this.difficulty]);
        w.onmessage = function(e) {
          this.board = generatePuzzle(e.data, this.difficulty);
          this.$.sudokuElement.updateValues(this.board);  
          this.$.random.disabled = false;
          this.loading = !this.loading;
          this.$.sudokuElement.updating = !this.$.sudokuElement.updating;
          this.count++;
        }.bind(this);
      },
      
      check: function() {
        //Load the current table to to a 2d array
        if (this.$.sudokuElement.check(this.dimension, this.chkX, this.chkY)) {
          this.$.successToast.open();
          this.randomize();
        } else this.$.errorToast.open();
      },

      toggleX: function(){
         this.chkX = this.$.chkX.checked;
      },

      toggleY: function(){
         this.chkY = this.$.chkY.checked;
      },
      
      setDiff: function(){
         this.difficulty = this.$.difficulty.value;
      },

      setDim: function(){
         this.dimension = this.$.dimension.value;
      },

      solve: function() {
        // console.log("solve function");
        let solver = new Worker("/src/js/worker2.js");
        // console.log(this.$.sudokuElement.getBoard());
        solver.postMessage([this.$.sudokuElement.getBoard(), this.chkX, this.chkY]);
        solver.onmessage = function(e) {
          // console.log(e.data);
          console.log(e.data[Math.floor(Math.random() * e.data.length)]);
          var sampleBoard = e.data[0];
          this.solutions = e.data;

        }
        // this.loading = !this.loading;
        // let s = new Worker("/src/js/worker2.js");
        // console.log(this.board);
        
        // var original_board = this.board.map(function(arr) {
        //     return arr.slice();
        // }).bind(this);;
        
        // s.postMessage(original_board,false,false);
        // s.onmessage = function(e) {
        //   this.solutions = e.data;
        // };
      }

    });
  </script>
</dom-module>
